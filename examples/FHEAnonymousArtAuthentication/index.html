<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Artwork Authentication Platform</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüé®%3C/text%3E%3C/svg%3E">
    <script>
        // Define functions before loading ethers.js
        var ethersReady = false;
        function ethersLoaded() {
            ethersReady = true;
            if (document.readyState === 'complete') {
                initializeWeb3();
            }
        }
        function loadEthersFallback() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
            fallbackScript.onload = ethersLoaded;
            document.head.appendChild(fallbackScript);
        }
    </script>
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js" onload="ethersLoaded()" onerror="loadEthersFallback()"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #12c2e9 0%, #c471ed 50%, #f64f59 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .connection-status {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
        }

        .section h2 {
            color: #c471ed;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #c471ed;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #c471ed;
        }

        .btn {
            background: linear-gradient(135deg, #12c2e9 0%, #c471ed 50%, #f64f59 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(196, 113, 237, 0.5);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .artwork-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .artwork-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid #f0f0f0;
            transition: border-color 0.3s ease;
        }

        .artwork-card:hover {
            border-color: #c471ed;
        }

        .artwork-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-authenticated {
            background: #d4edda;
            color: #155724;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .expert-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .expert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .expert-item:last-child {
            border-bottom: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #c471ed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .address {
            font-family: monospace;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-value {
            background: #c471ed;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 40px;
            text-align: center;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® Anonymous Artwork Authentication</h1>
            <p>Bias-free art verification through encrypted expert analysis</p>
        </div>

        <div class="connection-status" id="connectionStatus">
            <div class="loading"></div>
            Loading ethers.js library...
        </div>

        <div class="main-content">
            <!-- Artwork Submission Section -->
            <div class="section">
                <h2>Submit Artwork for Authentication</h2>
                <form id="artworkForm">
                    <div class="form-group">
                        <label for="artworkTitle">Artwork Title</label>
                        <input type="text" id="artworkTitle" placeholder="Enter artwork title" required>
                    </div>
                    <div class="form-group">
                        <label for="artworkAge">Estimated Age (years)</label>
                        <input type="number" id="artworkAge" placeholder="e.g., 150" min="1" max="2000" required>
                    </div>
                    <div class="form-group">
                        <label for="artworkStyle">Art Style</label>
                        <select id="artworkStyle" required>
                            <option value="">Select style</option>
                            <option value="renaissance">Renaissance</option>
                            <option value="baroque">Baroque</option>
                            <option value="impressionism">Impressionism</option>
                            <option value="modernist">Modernist</option>
                            <option value="contemporary">Contemporary</option>
                            <option value="abstract">Abstract</option>
                            <option value="classical">Classical</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="artworkMaterials">Materials Used</label>
                        <input type="text" id="artworkMaterials" placeholder="e.g., Oil on canvas" required>
                    </div>
                    <div class="form-group">
                        <label for="artworkCondition">Condition Score (0-100)</label>
                        <div class="range-container">
                            <input type="range" id="artworkCondition" min="0" max="100" value="80">
                            <span class="range-value" id="conditionValue">80</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="consensusRequired">Required Expert Consensus (%)</label>
                        <input type="number" id="consensusRequired" min="51" max="100" value="75" required>
                    </div>
                    <button type="submit" class="btn" id="submitArtworkBtn">
                        Submit for Authentication
                    </button>
                </form>
                <div id="artworkStatus"></div>
            </div>

            <!-- Expert Registration Section -->
            <div class="section">
                <h2>Expert Registration</h2>
                <form id="expertForm">
                    <div class="form-group">
                        <label for="expertName">Full Name</label>
                        <input type="text" id="expertName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="expertSpecialty">Area of Expertise</label>
                        <select id="expertSpecialty" required>
                            <option value="">Select specialty</option>
                            <option value="paintings">Paintings & Fine Art</option>
                            <option value="sculptures">Sculptures</option>
                            <option value="ceramics">Ceramics & Pottery</option>
                            <option value="textiles">Textiles & Fabrics</option>
                            <option value="manuscripts">Manuscripts & Documents</option>
                            <option value="jewelry">Jewelry & Precious Items</option>
                            <option value="furniture">Antique Furniture</option>
                            <option value="general">General Authentication</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expertExperience">Years of Experience</label>
                        <input type="number" id="expertExperience" min="1" max="50" placeholder="e.g., 15" required>
                    </div>
                    <div class="form-group">
                        <label for="expertCredentials">Professional Credentials</label>
                        <input type="text" id="expertCredentials" placeholder="Institution, certification, or reference" required>
                    </div>
                    <button type="submit" class="btn" id="registerExpertBtn">
                        Register as Expert
                    </button>
                </form>
                <div id="expertStatus"></div>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="section" id="authenticationSection">
            <h2>Submit Expert Authentication</h2>
            <form id="authenticationForm">
                <div class="form-group">
                    <label for="authArtworkId">Artwork ID</label>
                    <input type="number" id="authArtworkId" placeholder="Enter artwork ID to authenticate" required>
                </div>
                <div class="form-group">
                    <label for="authExpertId">Your Expert ID</label>
                    <input type="number" id="authExpertId" placeholder="Enter your verified expert ID" required>
                </div>
                <div class="form-group">
                    <label for="authenticityScore">Authenticity Assessment (0-100)</label>
                    <div class="range-container">
                        <input type="range" id="authenticityScore" min="0" max="100" value="50">
                        <span class="range-value" id="authenticityValue">50</span>
                    </div>
                    <small>0 = Definitely fake, 50 = Uncertain, 100 = Definitely authentic</small>
                </div>
                <div class="form-group">
                    <label for="confidenceScore">Confidence Level (0-100)</label>
                    <div class="range-container">
                        <input type="range" id="confidenceScore" min="0" max="100" value="70">
                        <span class="range-value" id="confidenceValue">70</span>
                    </div>
                    <small>How confident are you in your assessment?</small>
                </div>
                <div class="form-group">
                    <label for="authComments">Private Analysis Notes (Optional)</label>
                    <textarea id="authComments" rows="3" placeholder="Your private professional analysis..."></textarea>
                </div>
                <button type="submit" class="btn" id="submitAuthBtn">
                    Submit Authentication
                </button>
            </form>
            <div id="authenticationStatus"></div>
        </div>

        <!-- Artwork Gallery -->
        <div class="section">
            <h2>Artwork Gallery & Status</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="loadArtworks()" id="refreshArtworksBtn">
                    Refresh Gallery
                </button>
                <button class="btn btn-secondary" onclick="loadUserArtworks()" id="loadUserArtworksBtn">
                    My Submitted Artworks
                </button>
            </div>
            <div id="artworkGallery" class="artwork-grid">
                <div class="status info">
                    Click "Refresh Gallery" to load artworks from the blockchain
                </div>
            </div>
        </div>

        <!-- Expert Directory -->
        <div class="section">
            <h2>Expert Directory</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="loadExperts()" id="refreshExpertsBtn">
                    Refresh Expert List
                </button>
            </div>
            <div id="expertDirectory" class="expert-list">
                <div class="status info">
                    Click "Refresh Expert List" to load verified experts from the blockchain
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0x4D874585f820437656554590C812b672305fbb72';
        const CONTRACT_ABI = [
            "function submitArtwork(uint32 _metadataHash, uint8 _condition, uint256 _requiredConsensus) external returns (uint256)",
            "function registerExpert(uint8 _credentialsHash) external returns (uint256)",
            "function submitAuthentication(uint256 artworkId, uint256 expertId, uint8 _authenticity, uint8 _confidence) external",
            "function verifyExpert(uint256 expertId) external",
            "function getArtworkInfo(uint256 artworkId) external view returns (address artworkOwner, bool isSubmitted, bool isAuthenticated, uint256 submissionTime, uint256 authenticationCount, uint256 expertConsensus)",
            "function getExpertInfo(uint256 expertId) external view returns (address expertAddress, bool isVerified, uint256 authenticationsCompleted, uint256 successRate)",
            "function nextArtworkId() external view returns (uint256)",
            "function nextExpertId() external view returns (uint256)",
            "function owner() external view returns (address)",
            "event ArtworkSubmitted(uint256 indexed artworkId, address indexed owner)",
            "event ExpertRegistered(uint256 indexed expertId, address indexed expert)",
            "event AuthenticationSubmitted(uint256 indexed artworkId, uint256 indexed expertId)",
            "event ExpertVerified(uint256 indexed expertId, address indexed expert)"
        ];

        let provider;
        let signer;
        let contract;
        let userAccount;
        let isConnected = false;
        // ethersReady already declared in head

        // ethersLoaded and loadEthersFallback already declared in head

        function ethersError() {
            // As a final fallback, show manual connection instructions
            updateConnectionStatus(`
                <div>
                    <strong>Unable to load ethers.js library</strong><br>
                    This appears to be a network connectivity issue.<br><br>
                    <strong>To use this platform:</strong><br>
                    1. Check your internet connection<br>
                    2. Refresh this page<br>
                    3. Make sure you have MetaMask installed<br><br>
                    <strong>Contract Address:</strong><br>
                    <code style="background:#f0f0f0;padding:4px;border-radius:4px;font-family:monospace;">0x4D874585f820437656554590C812b672305fbb72</code><br><br>
                    <em>You can interact with this contract directly through MetaMask or other Web3 tools if needed.</em>
                </div>
            `, 'error');
        }

        // Initialize Web3 connection
        async function initializeWeb3() {
            try {
                if (!window.ethereum) {
                    updateConnectionStatus('MetaMask not detected. Please install MetaMask to use this platform.', 'error');
                    return;
                }

                // Check if already connected
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });

                if (accounts.length === 0) {
                    updateConnectionStatus('Click "Connect Wallet" to get started', 'info');
                    addConnectButton();
                    return;
                }

                // If already connected, proceed with setup
                await connectWallet();

            } catch (error) {
                console.error('Initialization error:', error);
                updateConnectionStatus('Failed to initialize. Please refresh the page.', 'error');
            }
        }

        // Add connect wallet button
        function addConnectButton() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = `
                <div class="status info">
                    MetaMask detected but not connected
                    <br><button class="btn" onclick="connectWallet()" style="margin-top: 10px;">Connect Wallet</button>
                </div>
            `;
        }

        // Connect wallet function
        async function connectWallet() {
            try {
                updateConnectionStatus('Connecting to MetaMask...', 'info');

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

                if (accounts.length === 0) {
                    throw new Error('No accounts found');
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAccount = await signer.getAddress();

                // Initialize contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Check network
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111) { // Sepolia
                    updateConnectionStatus(
                        'Wrong network detected. Please switch to Sepolia testnet in MetaMask.',
                        'warning'
                    );
                    addNetworkSwitchButton();
                    return;
                }

                isConnected = true;
                updateConnectionStatus(`Connected: ${formatAddress(userAccount)} on Sepolia`, 'success');

                // Enable forms
                enableForms();

            } catch (error) {
                console.error('Connection error:', error);

                if (error.code === 4001) {
                    updateConnectionStatus('Connection rejected by user. Click "Connect Wallet" to try again.', 'warning');
                    addConnectButton();
                } else {
                    updateConnectionStatus(`Connection failed: ${error.message}`, 'error');
                }
                isConnected = false;
            }
        }

        // Add network switch button
        function addNetworkSwitchButton() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = `
                <div class="status warning">
                    Please switch to Sepolia testnet
                    <br><button class="btn" onclick="switchToSepolia()" style="margin-top: 10px;">Switch to Sepolia</button>
                </div>
            `;
        }

        // Switch to Sepolia network
        async function switchToSepolia() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xaa36a7' }], // Sepolia chainId
                });
            } catch (switchError) {
                // If network doesn't exist, add it
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [
                                {
                                    chainId: '0xaa36a7',
                                    chainName: 'Sepolia Test Network',
                                    rpcUrls: ['https://sepolia.infura.io/v3/'],
                                    nativeCurrency: {
                                        name: 'ETH',
                                        symbol: 'ETH',
                                        decimals: 18,
                                    },
                                    blockExplorerUrls: ['https://sepolia.etherscan.io'],
                                },
                            ],
                        });
                    } catch (addError) {
                        console.error('Error adding network:', addError);
                        updateConnectionStatus('Failed to add Sepolia network', 'error');
                    }
                } else {
                    console.error('Error switching network:', switchError);
                    updateConnectionStatus('Failed to switch network', 'error');
                }
            }
        }

        // Update connection status display
        function updateConnectionStatus(message, type = 'info') {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Enable/disable forms based on connection
        function enableForms() {
            const buttons = document.querySelectorAll('button[type="submit"]');
            buttons.forEach(btn => {
                btn.disabled = !isConnected;
            });
        }

        // Format Ethereum address
        function formatAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        // Parse user-friendly error messages
        function parseErrorMessage(error) {
            // Extract readable error message from contract errors
            if (error.reason) {
                return error.reason;
            }

            if (error.message) {
                // Check for common error patterns
                if (error.message.includes('Expert not verified')) {
                    return '‚ùå Expert not verified. Please wait for admin to verify your expert account before submitting authentications.';
                }
                if (error.message.includes('Not the expert')) {
                    return '‚ùå You are not authorized to submit this authentication. Please check your expert ID.';
                }
                if (error.message.includes('Artwork does not exist')) {
                    return '‚ùå Artwork not found. Please check the artwork ID.';
                }
                if (error.message.includes('Already submitted')) {
                    return '‚ùå You have already submitted an authentication for this artwork.';
                }
                if (error.message.includes('user rejected')) {
                    return '‚ùå Transaction cancelled by user.';
                }
                if (error.message.includes('insufficient funds')) {
                    return '‚ùå Insufficient ETH balance to complete this transaction. Please get more Sepolia testnet ETH.';
                }
                if (error.message.includes('execution reverted')) {
                    // Try to extract the revert reason
                    const match = error.message.match(/execution reverted: (.+?)(?=\n|$|")/);
                    if (match && match[1]) {
                        return `‚ùå Transaction failed: ${match[1]}`;
                    }
                    return '‚ùå Transaction failed. Please check the transaction requirements and try again.';
                }

                // Default to generic message for unknown errors
                return `‚ùå Operation failed. ${error.message.substring(0, 100)}`;
            }

            return '‚ùå An unexpected error occurred. Please try again.';
        }

        // Show status messages
        function showStatus(type, message, elementId) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                if (statusDiv.innerHTML.includes(message)) {
                    statusDiv.innerHTML = '';
                }
            }, 8000);
        }

        // Generate metadata hash
        function generateMetadataHash(title, age, style, materials) {
            const metadata = `${title}-${age}-${style}-${materials}`;
            let hash = 0;
            for (let i = 0; i < metadata.length; i++) {
                const char = metadata.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash) % 4294967295;
        }

        // Generate credentials hash
        function generateCredentialsHash(name, specialty, experience, credentials) {
            const data = `${name}-${specialty}-${experience}-${credentials}`;
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                const char = data.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash) % 255;
        }

        // Handle range input updates
        ['artworkCondition', 'authenticityScore', 'confidenceScore'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                const valueId = id.replace('Score', 'Value').replace('Condition', 'Value');
                document.getElementById(valueId).textContent = this.value;
            });
        });

        // Handle artwork submission
        document.getElementById('artworkForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!isConnected) {
                showStatus('error', 'Please connect your wallet first', 'artworkStatus');
                return;
            }

            const submitBtn = document.getElementById('submitArtworkBtn');
            const originalText = submitBtn.textContent;

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loading"></div>Submitting...';

                const title = document.getElementById('artworkTitle').value;
                const age = document.getElementById('artworkAge').value;
                const style = document.getElementById('artworkStyle').value;
                const materials = document.getElementById('artworkMaterials').value;
                const condition = document.getElementById('artworkCondition').value;
                const consensus = document.getElementById('consensusRequired').value;

                showStatus('info', 'Generating metadata hash and submitting to blockchain...', 'artworkStatus');

                const metadataHash = generateMetadataHash(title, age, style, materials);

                const tx = await contract.submitArtwork(
                    metadataHash,
                    parseInt(condition),
                    parseInt(consensus)
                );

                showStatus('info', `Transaction submitted: ${tx.hash}. Waiting for confirmation...`, 'artworkStatus');

                const receipt = await tx.wait();
                const artworkId = receipt.events?.find(e => e.event === 'ArtworkSubmitted')?.args?.artworkId;

                showStatus('success', `Artwork submitted successfully! Artwork ID: ${artworkId || 'Check transaction'}`, 'artworkStatus');
                this.reset();
                document.getElementById('conditionValue').textContent = '80';

            } catch (error) {
                console.error('Submission error:', error);
                const friendlyError = parseErrorMessage(error);
                showStatus('error', friendlyError, 'artworkStatus');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Handle expert registration
        document.getElementById('expertForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!isConnected) {
                showStatus('error', 'Please connect your wallet first', 'expertStatus');
                return;
            }

            const submitBtn = document.getElementById('registerExpertBtn');
            const originalText = submitBtn.textContent;

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loading"></div>Registering...';

                const name = document.getElementById('expertName').value;
                const specialty = document.getElementById('expertSpecialty').value;
                const experience = document.getElementById('expertExperience').value;
                const credentials = document.getElementById('expertCredentials').value;

                showStatus('info', 'Generating credentials hash and submitting to blockchain...', 'expertStatus');

                const credentialsHash = generateCredentialsHash(name, specialty, experience, credentials);

                const tx = await contract.registerExpert(credentialsHash);

                showStatus('info', `Transaction submitted: ${tx.hash}. Waiting for confirmation...`, 'expertStatus');

                const receipt = await tx.wait();
                const expertId = receipt.events?.find(e => e.event === 'ExpertRegistered')?.args?.expertId;

                showStatus('success', `Expert registration successful! Expert ID: ${expertId || 'Check transaction'}. Awaiting admin verification.`, 'expertStatus');
                this.reset();

            } catch (error) {
                console.error('Registration error:', error);
                const friendlyError = parseErrorMessage(error);
                showStatus('error', friendlyError, 'expertStatus');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Handle authentication submission
        document.getElementById('authenticationForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!isConnected) {
                showStatus('error', 'Please connect your wallet first', 'authenticationStatus');
                return;
            }

            const submitBtn = document.getElementById('submitAuthBtn');
            const originalText = submitBtn.textContent;

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loading"></div>Submitting...';

                const artworkId = document.getElementById('authArtworkId').value;
                const expertId = document.getElementById('authExpertId').value;
                const authenticity = document.getElementById('authenticityScore').value;
                const confidence = document.getElementById('confidenceScore').value;

                showStatus('info', 'Submitting authentication to blockchain...', 'authenticationStatus');

                const tx = await contract.submitAuthentication(
                    parseInt(artworkId),
                    parseInt(expertId),
                    parseInt(authenticity),
                    parseInt(confidence)
                );

                showStatus('info', `Transaction submitted: ${tx.hash}. Waiting for confirmation...`, 'authenticationStatus');

                await tx.wait();

                showStatus('success', 'Authentication submitted successfully!', 'authenticationStatus');
                this.reset();
                document.getElementById('authenticityValue').textContent = '50';
                document.getElementById('confidenceValue').textContent = '70';

            } catch (error) {
                console.error('Authentication error:', error);
                const friendlyError = parseErrorMessage(error);
                showStatus('error', friendlyError, 'authenticationStatus');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Load artworks from blockchain
        async function loadArtworks() {
            if (!isConnected) {
                document.getElementById('artworkGallery').innerHTML = '<div class="status error">Please connect your wallet first</div>';
                return;
            }

            const gallery = document.getElementById('artworkGallery');
            const refreshBtn = document.getElementById('refreshArtworksBtn');

            try {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<div class="loading"></div>Loading...';

                gallery.innerHTML = '<div class="status info">Loading artworks from blockchain...</div>';

                const nextId = await contract.nextArtworkId();
                const artworks = [];

                for (let i = 1; i < nextId; i++) {
                    try {
                        const info = await contract.getArtworkInfo(i);
                        if (info.isSubmitted) {
                            artworks.push({
                                id: i,
                                owner: info.artworkOwner,
                                isAuthenticated: info.isAuthenticated,
                                submissionTime: new Date(info.submissionTime * 1000),
                                authenticationCount: info.authenticationCount,
                                consensus: info.expertConsensus
                            });
                        }
                    } catch (error) {
                        console.log(`Artwork ${i} not found or error:`, error.message);
                    }
                }

                if (artworks.length === 0) {
                    gallery.innerHTML = '<div class="status info">No artworks found on the blockchain</div>';
                    return;
                }

                gallery.innerHTML = artworks.map(artwork => `
                    <div class="artwork-card">
                        <h3>Artwork #${artwork.id}</h3>
                        <p><strong>Owner:</strong> <span class="address">${formatAddress(artwork.owner)}</span></p>
                        <p><strong>Status:</strong>
                            <span class="artwork-status ${artwork.isAuthenticated ? 'status-authenticated' : 'status-pending'}">
                                ${artwork.isAuthenticated ? 'Authenticated' : 'Pending'}
                            </span>
                        </p>
                        <p><strong>Expert Evaluations:</strong> ${artwork.authenticationCount}</p>
                        <p><strong>Required Consensus:</strong> ${artwork.consensus}%</p>
                        <p><strong>Submitted:</strong> ${artwork.submissionTime.toLocaleDateString()}</p>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading artworks:', error);
                gallery.innerHTML = `<div class="status error">Error loading artworks: ${error.message}</div>`;
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh Gallery';
            }
        }

        // Load user's artworks
        async function loadUserArtworks() {
            if (!isConnected) {
                document.getElementById('artworkGallery').innerHTML = '<div class="status error">Please connect your wallet first</div>';
                return;
            }

            const gallery = document.getElementById('artworkGallery');
            const loadBtn = document.getElementById('loadUserArtworksBtn');

            try {
                loadBtn.disabled = true;
                loadBtn.innerHTML = '<div class="loading"></div>Loading...';

                gallery.innerHTML = '<div class="status info">Loading your submitted artworks...</div>';

                const nextId = await contract.nextArtworkId();
                const userArtworks = [];

                for (let i = 1; i < nextId; i++) {
                    try {
                        const info = await contract.getArtworkInfo(i);
                        if (info.isSubmitted && info.artworkOwner.toLowerCase() === userAccount.toLowerCase()) {
                            userArtworks.push({
                                id: i,
                                isAuthenticated: info.isAuthenticated,
                                submissionTime: new Date(info.submissionTime * 1000),
                                authenticationCount: info.authenticationCount,
                                consensus: info.expertConsensus
                            });
                        }
                    } catch (error) {
                        console.log(`Artwork ${i} error:`, error.message);
                    }
                }

                if (userArtworks.length === 0) {
                    gallery.innerHTML = '<div class="status info">You haven\'t submitted any artworks yet</div>';
                    return;
                }

                gallery.innerHTML = userArtworks.map(artwork => `
                    <div class="artwork-card" style="border-color: #c471ed;">
                        <h3>Your Artwork #${artwork.id}</h3>
                        <p><strong>Status:</strong>
                            <span class="artwork-status ${artwork.isAuthenticated ? 'status-authenticated' : 'status-pending'}">
                                ${artwork.isAuthenticated ? 'Authenticated' : 'Pending Review'}
                            </span>
                        </p>
                        <p><strong>Expert Reviews:</strong> ${artwork.authenticationCount}</p>
                        <p><strong>Consensus Required:</strong> ${artwork.consensus}%</p>
                        <p><strong>Submitted:</strong> ${artwork.submissionTime.toLocaleDateString()}</p>
                        ${!artwork.isAuthenticated ?
                            '<p><small style="color: #856404;">‚è≥ Waiting for expert evaluations</small></p>' :
                            '<p><small style="color: #155724;">‚úÖ Authentication completed</small></p>'
                        }
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading user artworks:', error);
                gallery.innerHTML = `<div class="status error">Error loading your artworks: ${error.message}</div>`;
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'My Submitted Artworks';
            }
        }

        // Load experts from blockchain
        async function loadExperts() {
            if (!isConnected) {
                document.getElementById('expertDirectory').innerHTML = '<div class="status error">Please connect your wallet first</div>';
                return;
            }

            const directory = document.getElementById('expertDirectory');
            const refreshBtn = document.getElementById('refreshExpertsBtn');

            try {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<div class="loading"></div>Loading...';

                directory.innerHTML = '<div class="status info">Loading experts from blockchain...</div>';

                const nextId = await contract.nextExpertId();
                const contractOwner = await contract.owner();
                const isOwner = userAccount.toLowerCase() === contractOwner.toLowerCase();
                const experts = [];

                for (let i = 1; i < nextId; i++) {
                    try {
                        const info = await contract.getExpertInfo(i);
                        if (info.expertAddress !== '0x0000000000000000000000000000000000000000') {
                            experts.push({
                                id: i,
                                address: info.expertAddress,
                                isVerified: info.isVerified,
                                completed: info.authenticationsCompleted,
                                successRate: info.successRate
                            });
                        }
                    } catch (error) {
                        console.log(`Expert ${i} not found:`, error.message);
                    }
                }

                if (experts.length === 0) {
                    directory.innerHTML = '<div class="status info">No experts registered yet</div>';
                    return;
                }

                // Show admin badge if user is owner
                let htmlContent = '';
                if (isOwner) {
                    htmlContent += `
                        <div class="status success" style="margin-bottom: 15px;">
                            üîê <strong>Admin Access</strong> - You are the contract owner. Click "Verify" to approve expert registrations.
                        </div>
                    `;
                }

                htmlContent += experts.map(expert => `
                    <div class="expert-item">
                        <div>
                            <strong>Expert #${expert.id}</strong>
                            <br><span class="address">${formatAddress(expert.address)}</span>
                            ${expert.address.toLowerCase() === userAccount.toLowerCase() ?
                                '<br><small style="color: #c471ed; font-weight: 600;">‚Üê This is you</small>' : ''
                            }
                        </div>
                        <div style="text-align: right;">
                            <span class="artwork-status ${expert.isVerified ? 'status-authenticated' : 'status-pending'}">
                                ${expert.isVerified ? 'Verified' : 'Pending Verification'}
                            </span>
                            ${expert.isVerified ?
                                `<br><small>${expert.completed} completed ‚Ä¢ ${expert.successRate}% success rate</small>` :
                                `<br><small>Awaiting admin verification</small>${
                                    isOwner && !expert.isVerified ?
                                    `<br><button class="btn btn-success" style="margin-top: 5px; padding: 6px 15px; font-size: 12px;" onclick="verifyExpert(${expert.id})">‚úì Verify Expert</button>` :
                                    ''
                                }`
                            }
                        </div>
                    </div>
                `).join('');

                directory.innerHTML = htmlContent;

            } catch (error) {
                console.error('Error loading experts:', error);
                directory.innerHTML = `<div class="status error">Error loading experts: ${error.message}</div>`;
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh Expert List';
            }
        }

        // Verify expert (admin only)
        async function verifyExpert(expertId) {
            if (!isConnected) {
                alert('Please connect your wallet first');
                return;
            }

            if (!confirm(`Are you sure you want to verify Expert #${expertId}? This will allow them to submit authentications.`)) {
                return;
            }

            try {
                const tx = await contract.verifyExpert(expertId);
                alert(`‚úì Verification transaction submitted: ${tx.hash}\n\nWaiting for confirmation...`);

                await tx.wait();

                alert(`‚úÖ Expert #${expertId} has been successfully verified!`);

                // Refresh expert list
                loadExperts();

            } catch (error) {
                console.error('Verification error:', error);
                const friendlyError = parseErrorMessage(error);
                alert(friendlyError);
            }
        }

        // Handle account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    updateConnectionStatus('Wallet disconnected. Click "Connect Wallet" to reconnect.', 'warning');
                    isConnected = false;
                    enableForms();
                    addConnectButton();
                } else {
                    // Account changed, reconnect
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                // Chain changed, check if it's Sepolia
                const sepoliaChainId = '0xaa36a7';
                if (chainId === sepoliaChainId) {
                    connectWallet();
                } else {
                    updateConnectionStatus('Please switch to Sepolia testnet', 'warning');
                    addNetworkSwitchButton();
                    isConnected = false;
                    enableForms();
                }
            });
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            if (ethersReady && typeof ethers !== 'undefined') {
                initializeWeb3();
            } else {
                // Wait for ethers to load
                setTimeout(() => {
                    if (typeof ethers !== 'undefined') {
                        initializeWeb3();
                    } else {
                        updateConnectionStatus('Failed to load ethers.js library. Please check your internet connection and refresh.', 'error');
                    }
                }, 2000);
            }
        });

        // Auto-refresh data every 30 seconds
        setInterval(() => {
            if (isConnected) {
                loadArtworks();
                loadExperts();
            }
        }, 30000);
    </script>
</body>
</html>